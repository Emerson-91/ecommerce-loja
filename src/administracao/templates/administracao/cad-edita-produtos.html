{% extends 'administracao/base_admin.html' %}
{% load form_extras %}

{% block title %}{% if produto %}Editar{% else %}Cadastrar{% endif %} Produto{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-gray-900 mb-8">
    {% if produto %}Editar{% else %}Cadastrar{% endif %} Produto
</h1>

<form method="post" enctype="multipart/form-data" class="space-y-10">
    {% csrf_token %}

    <!-- Dados do produto -->
    <section class="bg-white p-6 rounded-xl shadow border border-gray-200">
        <h2 class="text-xl font-semibold mb-6 text-gray-800">Dados do Produto</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for field in form %}
            <div class="space-y-1">
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                {{ field|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" }}
                {% if field.errors %}
                    {% for error in field.errors %}
                    <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                    {% endfor %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Variações -->
    <script>
const tamanhosPorTipo = {
    'NORMAL': ['P', 'M', 'G', 'GG'],
    'PLUS': ['P', 'M', 'G', 'GG'],
    'NUMERACAO': ['36', '38', '40', '42', '44', '46']
};

function atualizarTamanhos(selectTipo, selectTamanho) {
    const tipo = selectTipo.value || 'NORMAL'; // Garante valor padrão
    const tamanhos = tamanhosPorTipo[tipo] || [];
    const valorOriginal = selectTamanho.dataset.value || '';
    selectTamanho.innerHTML = '';
    const optDefault = document.createElement('option');
    optDefault.value = '';
    optDefault.textContent = '--- Selecione ---';
    selectTamanho.appendChild(optDefault);
    tamanhos.forEach(function(t) {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        selectTamanho.appendChild(opt);
    });
    // Restaura o valor original se existir
    if (valorOriginal) {
        selectTamanho.value = valorOriginal;
    }
}

// Para todos os forms já renderizados
document.querySelectorAll('.variacao-form').forEach(function(form) {
    const selectTipo = form.querySelector('select[name$="tipo_tamanho"]');
    const selectTamanho = form.querySelector('select[name$="tamanho"]');
    if (selectTipo && selectTamanho) {
        selectTipo.addEventListener('change', function() {
            atualizarTamanhos(selectTipo, selectTamanho);
        });
        // Atualiza ao carregar a página
        atualizarTamanhos(selectTipo, selectTamanho);
    }
});

// Para novos forms adicionados
document.getElementById('add-variacao').addEventListener('click', function() {
    var container = document.getElementById('variacoes-container');
    var totalForms = document.querySelector('[name="variacaoproduto_set-TOTAL_FORMS"]');
    var currentCount = parseInt(totalForms.value);

    var forms = container.querySelectorAll('.variacao-form');
    var lastForm = forms[forms.length - 1];
    var newForm = lastForm.cloneNode(true);

    // Limpa os valores dos inputs e selects
    newForm.querySelectorAll('input, select').forEach(function(input) {
        if (input.type !== 'hidden') input.value = '';
        if (input.type === 'checkbox') input.checked = false;
    });

    // Atualiza os índices dos campos
    newForm.innerHTML = newForm.innerHTML.replace(
        new RegExp('variacaoproduto_set-' + (currentCount - 1), 'g'),
        'variacaoproduto_set-' + currentCount
    );

    container.appendChild(newForm);
    totalForms.value = currentCount + 1;

    // Atualiza o select de tamanho do novo form
    setTimeout(function() {
        const selectTipo = newForm.querySelector('select[name$="tipo_tamanho"]');
        const selectTamanho = newForm.querySelector('select[name$="tamanho"]');
        if (selectTipo && selectTamanho) {
            atualizarTamanhos(selectTipo, selectTamanho);
            selectTipo.addEventListener('change', function() {
                atualizarTamanhos(selectTipo, selectTamanho);
            });
        }
    }, 50);
});
</script>
    <section class="bg-white p-6 rounded-xl shadow border border-gray-200">
        <h2 class="text-xl font-semibold mb-6 text-gray-800">Variações</h2>

        {{ variacoes_formset.management_form }}

        <div id="variacoes-container" class="space-y-4">
            {% for form in variacoes_formset %}
            <div class="variacao-form border border-gray-300 rounded-lg bg-gray-50 p-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="space-y-1">
                    <label for="{{ form.tipo_tamanho.id_for_label }}" class="block text-sm font-medium text-gray-700">Tipo de Tamanho</label>
                    {{ form.tipo_tamanho|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" }}
                    {% if form.tipo_tamanho.errors %}
                        {% for error in form.tipo_tamanho.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="space-y-1">
                    <label for="{{ form.tamanho.id_for_label }}" class="block text-sm font-medium text-gray-700">Tamanho</label>
                    <select name="{{ form.tamanho.html_name }}" id="{{ form.tamanho.id_for_label }}"
    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"
    data-value="{{ form.tamanho.value }}">
</select>
                    {% if form.tamanho.errors %}
                        {% for error in form.tamanho.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="space-y-1">
                    <label for="{{ form.cor.id_for_label }}" class="block text-sm font-medium text-gray-700">Cor</label>
                    {{ form.cor|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" }}
                    {% if form.cor.errors %}
                        {% for error in form.cor.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="space-y-1">
                    <label for="{{ form.estoque.id_for_label }}" class="block text-sm font-medium text-gray-700">Estoque</label>
                    {{ form.estoque|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" }}
                    {% if form.estoque.errors %}
                        {% for error in form.estoque.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                {{ form.DELETE }} <!-- Para permitir exclusão de variação -->
            </div>
            {% endfor %}
        </div>

        <button type="button" id="add-variacao" class="mt-4 inline-block px-5 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition text-sm">
            + Adicionar Variação
        </button>
    </section>

    <!-- Botão -->
    <div>
        <button type="submit" class="w-full md:w-auto px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded shadow transition">
            Salvar Produto
        </button>
    </div>
</form>

{% endblock %}
